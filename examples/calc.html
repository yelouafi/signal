<!doctype html>
<html>
<head>

<style>
	td {
		border: 1px solid #ddd;
		background-color: #eee;
		width: 60px;
		height: 40px;
		text-align: center;
		vertical-align: center;
	}
	
	td:hover {
		background-color: #e6e6e6;
	}
	
	#output {
		border: 1px solid #ddd;
		background-color: #fff;
	}
</style>

</head>
<body>

<div>
	<p> Calculator
		<table>
			<tbody>
				<tr>
					<td colspan=4 id="output"></td>
				</tr>
			</tbody>
			<tbody id="buttons">
				<tr>
					<td>7</td><td>8</td><td>9</td><td>/</td>
				</tr>
				<tr>
					<td>4</td><td>5</td><td>6</td><td>*</td>
				</tr>
				<tr>
					<td>1</td><td>2</td><td>3</td><td>-</td>
				</tr>
				<tr>
					<td>0</td><td>,</td><td>=</td><td>+</td>
				</tr>
			</tbody>
			
		</table>
	</p>
</div>
<script src="../signal.js"></script>
<script src="../signal.dom.js"></script>
<script>
	
	function isDigit(c) { return /\d/.test(c); }
	function isOp(c) { return '+-*/'.indexOf(c) >= 0; }
	function calc(st) {
		var opmap = {
			'+': function(a, b) { return a+b },
			'-': function(a, b) { return a-b },
			'*': function(a, b) { return a*b },
			'/': function(a, b) { return a/b }
		}
		var res = st[0];
		for(var i=1; i<st.length; i+=2) {
			var n = st[i+1], op = st[i];
			if( n !== undefined ) {
				res = opmap[op](res, +n);
			}
		}
		return res;
	}
	function fmt(s) { return s.join(' '); }
	
	var btn = $$('buttons').$click('td', '.target.textContent');
	var op = btn.filter( isOp ),
		digit = btn.filter( isDigit );
	
	function arrRepHead(arr, newHead, fn) {
		var head = arr[arr.length-1];
		return arr.slice(0, arr.length-1).concat( fn ? fn(head,newHead) : newHead  );
	}
	var calc = ss.fsm( ['dig', 0], [
		[eq, 			function( p ) { return [ 'digEq', [ calc(p) ] ] } ],
		[op, {
			'op':		function( p, o ) { return ['op', p.slice(0, p.length-1).concat(o)] },
			'*':		function( p, o ) { return ['op', p.concat(o)] }
		}],
		[digit, {
			'dig':		function( p, o ) { return ['dig', p.slice(0, p.length-1).concat( p[p.length-1] + '' + o ) }] },
			'op':		function( p, d ) { return ['dig', p.concat(o)] },
			'digEq':	function( p, d ) { return ['dig', p.slice(0, p.length-1).concat(o)]] },
		}]
	
	]);
	$$('output').text( stream.map( fmt ) );

</script>
</body>
</html>