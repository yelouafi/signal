<!doctype html>
<html>
<head>
	<style>
		[template] {
			display: none !important;
		}
		.done {
		  text-decoration: line-through;
		  color: grey;
		}
		.error {
			border: 1px solid red;
		}
	</style>

</head>
<body>
<h1>Simple Todos App</h1>
<div>
    <p>
        <input type="text" id="todoText">
        <button id="addTodo">Add</button>
    </p>
    <p>
    	Todo List
    	<a href="#" class="sort">sort</a>
    </p>
    <ul id="todoList">
        <li template id=todo>
			<input type="checkbox" class="done" /> 
			<span class="todoText">todo here</span>
			<button class="remove" >Remove</button>
		</li>
    </ul>
</div>

<script src="../score.js"></script>
<script src="../signal.js"></script>
<script src="../score.dom.js"></script>
<script>
var _ = ss_;
var todoList = $('#todoList'),
	todoText = $('#todoText'),
	addTodo = $('#addTodo'),
	
	newTodo = ss.obj({ text: addTodo.$click().map(todoText.getter('value')) }),
	removeTodo = todoList.signal('li', '$removeTodo').map('.detail.data'),
	sortTodos = $('.sort').$click(),
	
	ttodo = $.t('todo', function(data) {
		return { 
			css: { done: this.$('.done').$checked() },
			'>span': { text: data.text },
			$removeTodo: this.$('.remove').$click().val(data)
		};
	});
	
function todos(add, remove, sort) {
	
	function isValid(todo) {
		return todo.text && todo.text.trim();
	}
	
	var addValid 	= add.filter(isValid);
	var addInvalid 	= add.filter(_.fnot(isValid));
	
	var todos = ss.def([],
		[addValid, function(todo) { 
			return todos().concat(todo); }],
		[remove, function(todo) { 
			var arr = todos().slice(); 
			_.remove(arr, todo); 
			return arr; }],
		[sort, function () {
			return _.sort(todos().slice(), 'text');
		}]
	);
	return {
		addValid: addValid,
		addInvalid: addInvalid,
		todos: todos
	}
	
}

var mTodos = todos(newTodo, removeTodo, sortTodos);
var textError = ss.bstate(false, mTodos.addInvalid, mTodos.addValid).log('text error: ');
$(todoText, {
	value: mTodos.addValid.val(''),
	css: { error: textError },
	focus: mTodos.addValid
});

$(todoList, { 
	children: ttodo.collect(mTodos.todos)
});


</script>
</body>
</html>